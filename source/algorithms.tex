\subsection{Formal definition of the \acronymWSNOptimisation{}{} algorithm}

We formally define the \acronymWSNOptimisation{}{} algorithm in two parts, Algorithm \ref{alg:wsn_optimisation_sink} for sink node agents receiving composite tasks, and Algorithm \ref{alg:wsn_optimisation_arc} for other agents belonging to the task-path for an atomic task.

In the \acronymWSNOptimisationSink{}{} algorithm, Algorithm \ref{alg:wsn_optimisation_sink}, the sink node receives a composite task $\varCompositeTask{}{}$ comprising of multiple atomic tasks $\varAtomicTask{}{}$ to be completed. For each of these atomic tasks the sink node agent runs the \acronymATARIA{}{} algorithm to select an action (Line \ref{wsnsink:select}). It can execute the atomic task itself (Line \ref{wsnsink:exec}), using the \acronymMGRAO{}{} algorithm to determine the resources that will be allocated to its completion, or allocate it to another agent it knows about to complete using the \acronymWSNOptimisationArc{}{} algorithm (Line \ref{wsnsink:alloc}). In both cases, once the task is completed, the sink node agent receives an atomic task quality value of $\functionAtomicTaskQualitySignature{}{}$ and removes the atomic task from the list of tasks to complete. 

If a $\functionInfo{}{}$ or $\functionLink{}{}$ action is executed, there is no effect on atomic task execution or allocation in that step, and the algorithm loops round to choose another action using \acronymATARIA{}{}.

Once all atomic tasks have completed, each atomic tasks' proportional value to the composite task is calculated. For each atomic task, the corresponding value is sent to the last agent in the atomic tasks' task-path so that each sensor agent can carry out an \acronymMGRAO{}{}-update to re-allocate its resources to increase the tasks' value in the future (Lines \ref{wsnsink:arc_last} and \ref{wsnsink:mgrao}). 

\begin{algorithm}[ht]
	\DontPrintSemicolon
	\footnotesize
	
	\caption{\textbf{The \acronymWSNOptimisationSink{}{} algorithm}}
	\label{alg:wsn_optimisation_sink}
	{
		\KwIn{ $\varCompositeTask{}{}$ , The composite task set}
		\KwIn{ $\varAgent{}{}$ , The sink agent completing the composite task}
		\KwResult{$\functionCompositeTaskQuality{}{}{}{}$ , The composite task quality of $\varCompositeTask{}{}$}		\nonl \;
		\tcp{Copy set of atomic tasks to list of incomplete tasks}
		$ctactive \leftarrow \varCompositeTask{}{}$ \label{wsnsink:copy}\;
		\For{$\varAtomicTask{}{} \in ctactive$\label{wsnsink:composite_tasks}}
		{
			\tcp{Select and execute action through \acronymATARIA{}{}}
			$\varAction{}{} \leftarrow \functionATARIAAction{}{}$ \label{wsnsink:select} \;	
			\If{$\varAction{}{} = \functionExec{}{} || \varAction{}{} = \functionAlloc{\varAtomicTask{}{}}{\varAgent{}{'}}$?}
			{
				\tcp{If the action was completed by agent $\varAgent{}{}$ or by allocating to another agent $\varAgent{}{'}$, remove atomic task from incomplete task list}
				$ctactive{}{} \leftarrow ctactive - \lbrace \varAtomicTask{}{} \rbrace$ \label{wsnsink:exec_remove}\;
			}
		}
		\For{$\varAtomicTask{}{} \in \varCompositeTask{}{}$\label{ataria:composite_tasks}}
		{
			\tcp{Send a proportion of the absolute task value for the atomic task to each agent in its task-path}
			\ForEach{$\varAgent{'}{}\in \functionTaskArc{}{}$}{
				\tcp{Update the Q-values for actions taken by agents in each atomic tasks' task-path}
				$\varTaskValue{}{} \leftarrow \functionTaskAbsoluteValue{}{}
				$ \label{wsnsink:ataria-taskval}\;	
				$\functionSignature{\texttt{ataria-update}}{
					\varAgent{}{'}, \varAtomicTask{}{}, \frac{\varTaskValue{}{}}{\funcSize{\varCompositeTask{}{}}}
				}$ \label{wsnsink:ataria-update}\;	
			}
			\tcp{Send the agent that completed the atomic task the absolute task value to run the MGRAO update}
			$\functionSignature{\texttt{mgrao-update}}{\varAgent{}{}, \varAtomicTask{}{}, \varTaskValue{}{}}$ \label{wsnsink:mgrao}\;	
		}
		\Return{$\functionCompositeTaskQuality{}{}{}{}$}
	}
\end{algorithm}

The \acronymWSNOptimisationArc{}{} algorithm (Algorithm \ref{alg:wsn_optimisation_arc}) will complete an atomic task and return its quality, either by executing the task itself (Line \ref{wsnarc:exec}), or re-allocating to another agent (Line \ref{wsnarc:alloc}). The \acronymATARIA{}{} algorithm is run and an action selected (Line \ref{wsnarc:select}), in the same way as in the \acronymWSNOptimisationSink{}{} algorithm. The selection and execution of actions using the \acronymATARIA{}{} algorithm is repeated until the task in completed an atomic task quality can be returned (Line \ref{wsnarc:exec}).
\begin{algorithm}[ht]
	\DontPrintSemicolon
	\footnotesize
	
	\caption{\textbf{The \acronymWSNOptimisationArc{}{} algorithm } }
	\label{alg:wsn_optimisation_arc}
	{
		\KwIn{ $\varAtomicTask{}{}$ , The atomic task to be completed}
		\KwIn{ $\varAgent{}{}$ , The agent completing the atomic task}
		\KwResult{$\functionAtomicTaskQualitySignature{}{}$ , The atomic task quality of $\varAtomicTask{}{}$}
		\nonl \;
		
		$taskComplete \leftarrow False$ \;
		\While{$\neg taskComplete$ }{
		\tcp{Select and execute action through \acronymATARIA{}{}}
		$\varAction{}{} \leftarrow \functionATARIAAction{}{}$ \label{wsnarc:select} \;
		\tcp{If the action was completed by agent $\varAgent{}{}$ or by allocating to another agent $\varAgent{}{'}$, mark it complete}
		\uIf{$\varAction{}{} = \functionExec{}{} || \varAction{}{} = \functionAlloc{\varAtomicTask{}{}}{\varAgent{}{'}}$?}
		{
			$taskComplete \leftarrow True$ \;
		}
	}
	\tcp{Return the task quality of the atomic task completion}
	\Return{$\functionAtomicTaskQualitySignature{}{}$\label{wsnarc:return}} \;
	}
\end{algorithm}